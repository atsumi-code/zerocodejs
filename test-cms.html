<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ZeroCode.js - Test</title>

    <!-- 共通CSS（リセットCSS含む） -->
    <link rel="stylesheet" href="./css/common.css" />
    <!-- ページ専用CSS -->
    <link rel="stylesheet" href="./css/page.css" />
    <!-- サンプルデータ用CSS -->
    <link rel="stylesheet" href="./css/sample.css" />
  </head>
  <body>
    <div class="l-header l-header--cms">
      <h1>ZeroCodeCMS - ユーザー用管理画面テスト</h1>
      <p>編集機能付き（パーツ管理・画像管理なし）</p>
    </div>

    <div class="l-container">
      <zcode-cms
        id="test-cms"
        locale="ja"
        config='{"cms":{"imageModalActions":{"special":{"add":true,"delete":true}}}}'
      >
        <!-- 共通CSS（リセットCSS含む） -->
        <link slot="css" rel="stylesheet" href="./css/common.css" />
        <!-- ページ専用CSS -->
        <link slot="css" rel="stylesheet" href="./css/page.css" />
        <!-- サンプルデータ用CSS -->
        <link slot="css" rel="stylesheet" href="./css/sample.css" />
        <!-- Scriptスロット（jQueryとアコーディオン） -->
        <script
          slot="script"
          src="https://code.jquery.com/jquery-3.7.1.min.js"
          integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
          crossorigin="anonymous"
        ></script>
        <script slot="script" src="./js/accordion.js"></script>
      </zcode-cms>
    </div>

    <div class="l-footer l-footer--cms">
      <h1>ZeroCodeCMS - ユーザー用管理画面テスト</h1>
      <p>編集機能付き（パーツ管理・画像管理なし）</p>
    </div>

    <!-- リセットボタン（保存ボタンの横に配置） -->
    <div id="reset-controls-fixed" class="reset-controls-fixed">
      <button id="reset-data-btn" class="reset-btn">
        <svg
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" />
          <path d="M21 3v5h-5" />
          <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" />
          <path d="M3 21v-5h5" />
        </svg>
        <span>リセット</span>
      </button>
    </div>

    <!-- 共通JavaScript -->
    <script src="./js/common.js"></script>
    <!-- メインスクリプト -->
    <script type="module" src="/src/index.ts"></script>

    <script>
      let cms = null;

      async function init() {
        await waitForCMS();
        setTimeout(() => {
          cms = document.getElementById('test-cms');
          if (cms) {
            // ローカルストレージからデータを読み込んで適用
            const data = ZeroCodeCommon.StorageManager.loadData('test-cms');
            if (data.page.length === 0) {
              // データがない場合はサンプルデータを読み込む
              ZeroCodeCommon.StorageManager.saveSampleData('test-cms');
            }
            ZeroCodeCommon.StorageManager.applyToComponent('test-cms');

            // コンテンツ更新イベントを発火（動的コンテンツ用フック）
            const event = new CustomEvent('cms-content-updated');
            window.dispatchEvent(event);
            if (typeof jQuery !== 'undefined') {
              jQuery(document).trigger('cms-content-updated');
            }

            // リセットボタンのイベントリスナー
            const resetBtn = document.getElementById('reset-data-btn');
            const resetControls = document.getElementById('reset-controls-fixed');
            if (resetBtn && resetControls) {
              resetBtn.addEventListener('click', () => {
                if (confirm('すべてのデータをリセットしますか？この操作は取り消せません。')) {
                  const instanceId = 'test-cms';
                  ZeroCodeCommon.StorageManager.clear(instanceId);
                  ZeroCodeCommon.StorageManager.saveSampleData(instanceId);
                  window.location.reload();
                }
              });

              // 表示モード変更イベントをリッスン
              cms.addEventListener('view-mode-changed', (event) => {
                const mode = event.detail.mode;
                if (mode === 'preview') {
                  // 表示モードの時はリセットボタンを非表示
                  resetControls.style.display = 'none';
                } else {
                  // 管理モードの時はリセットボタンを表示
                  resetControls.style.display = 'flex';
                }
              });
            }
          }
        }, 100);
      }

      function waitForCMS() {
        return new Promise((resolve) => {
          if (customElements.get('zcode-cms')) {
            resolve();
          } else {
            customElements.whenDefined('zcode-cms').then(resolve);
          }
        });
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    </script>
  </body>
</html>
