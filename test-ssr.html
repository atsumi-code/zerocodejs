<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ZeroCode SSR - Test</title>

    <!-- å…±é€šCSSï¼ˆãƒªã‚»ãƒƒãƒˆCSSå«ã‚€ï¼‰ -->
    <link rel="stylesheet" href="./css/common.css" />
    <!-- ãƒšãƒ¼ã‚¸å°‚ç”¨CSS -->
    <link rel="stylesheet" href="./css/page.css" />
    <!-- ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç”¨CSS -->
    <link rel="stylesheet" href="./css/sample.css" />

    <style>
      .comparison-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
      }
      .comparison-section {
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 16px;
        background: #f9fafb;
      }
      .comparison-section h2 {
        margin-top: 0;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 2px solid #3b82f6;
        color: #1f2937;
      }
      .comparison-section.ssr h2 {
        border-bottom-color: #10b981;
      }
      .comparison-section.client h2 {
        border-bottom-color: #3b82f6;
      }
      .output-area {
        border: 1px solid #d1d5db;
        border-radius: 4px;
        padding: 16px;
        background: white;
        min-height: 200px;
      }
      .status {
        margin-top: 12px;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 14px;
      }
      .status.success {
        background: #d1fae5;
        color: #065f46;
      }
      .status.error {
        background: #fee2e2;
        color: #991b1b;
      }
      .status.info {
        background: #dbeafe;
        color: #1e40af;
      }
      .error-message {
        color: #dc2626;
        padding: 12px;
        background: #fee2e2;
        border-radius: 4px;
        margin-top: 8px;
      }
    </style>
  </head>
  <body>
    <div class="l-header l-header--ssr">
      <h1>ZeroCode SSR - ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ¤œè¨¼</h1>
      <p>SSRã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã®çµæœã‚’æ¯”è¼ƒã—ã¾ã™</p>
    </div>

    <div class="l-container">
      <div class="comparison-container">
        <!-- SSRçµæœ -->
        <div class="comparison-section ssr">
          <h2>ğŸ“¦ ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° (SSR)</h2>
          <div id="ssr-output" class="output-area">
            <p style="color: #6b7280">ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸­...</p>
          </div>
          <div id="ssr-status" class="status info">æº–å‚™ä¸­...</div>
        </div>

        <!-- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰çµæœï¼ˆæ¯”è¼ƒç”¨ - renderToHtmlã‚’ä½¿ç”¨ï¼‰ -->
        <div class="comparison-section client">
          <h2>ğŸŒ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆæ¯”è¼ƒç”¨ï¼‰</h2>
          <div id="client-output" class="output-area">
            <p style="color: #6b7280">ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸­...</p>
          </div>
          <div id="client-status" class="status info">æº–å‚™ä¸­...</div>
        </div>
      </div>

      <!-- æ¯”è¼ƒçµæœ -->
      <div
        id="comparison-result"
        style="
          margin-top: 20px;
          padding: 16px;
          border-radius: 8px;
          background: #f3f4f6;
          display: none;
        "
      >
        <h3>æ¯”è¼ƒçµæœ</h3>
        <div id="comparison-details"></div>
      </div>
    </div>

    <div class="l-footer l-footer--ssr">
      <h1>ZeroCode SSR - ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ¤œè¨¼</h1>
      <p>SSRã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã®çµæœã‚’æ¯”è¼ƒã—ã¾ã™</p>
    </div>

    <!-- å…±é€šJavaScript -->
    <script src="./js/common.js"></script>
    <!-- ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script type="module" src="/src/index.ts"></script>

    <script type="module">
      import { renderToHtml } from '/src/index.ts'

      async function init() {
        // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const rawData = ZeroCodeCommon.StorageManager.loadData('test-cms')
        if (rawData.page.length === 0) {
          ZeroCodeCommon.StorageManager.saveSampleData('test-cms')
          // å†èª­ã¿è¾¼ã¿
          const updatedData = ZeroCodeCommon.StorageManager.loadData('test-cms')
          Object.assign(rawData, updatedData)
        }

        // StorageManagerã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ZeroCodeDataå½¢å¼ã«å¤‰æ›
        const sampleData = {
          page: rawData.page,
          css: {
            common: rawData.cssCommon || '',
            individual: rawData.cssIndividual || '',
            special: rawData.cssSpecial || ''
          },
          parts: {
            common: rawData.typesCommon || [],
            individual: rawData.typesIndividual || [],
            special: rawData.typesSpecial || []
          },
          images: {
            common: rawData.imagesCommon || [],
            individual: rawData.imagesIndividual || [],
            special: rawData.imagesSpecial || []
          }
        }

        // CSSã‚’<style>ã‚¿ã‚°ã¨ã—ã¦æº–å‚™ï¼ˆå…±é€š â†’ å€‹åˆ¥ â†’ ç‰¹åˆ¥ã®é †ï¼‰
        let styleTags = '';
        if (sampleData.css.common) {
          styleTags += `<style id="zcode-css-style-common" data-zcode-css-category="common">${sampleData.css.common}</style>`;
        }
        if (sampleData.css.individual) {
          styleTags += `<style id="zcode-css-style-individual" data-zcode-css-category="individual">${sampleData.css.individual}</style>`;
        }
        if (sampleData.css.special) {
          styleTags += `<style id="zcode-css-style-special" data-zcode-css-category="special">${sampleData.css.special}</style>`;
        }

        // SSRãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        try {
          const ssrHtml = renderToHtml(sampleData, {
            enableEditorAttributes: false
          })

        document.getElementById('ssr-output').innerHTML = styleTags + ssrHtml
        document.getElementById('ssr-status').textContent = 'ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æˆåŠŸ'
          document.getElementById('ssr-status').className = 'status success'
        } catch (error) {
          console.error('SSR Error:', error)
          document.getElementById('ssr-output').innerHTML =
            `<div class="error-message">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`
          document.getElementById('ssr-status').textContent = `ã‚¨ãƒ©ãƒ¼: ${error.message}`
          document.getElementById('ssr-status').className = 'status error'
        }

        // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆæ¯”è¼ƒç”¨ - renderToHtmlã‚’ä½¿ç”¨ï¼‰
        try {
          const clientHtml = renderToHtml(sampleData, {
            enableEditorAttributes: false
          })

        document.getElementById('client-output').innerHTML = styleTags + clientHtml
        document.getElementById('client-status').textContent = 'ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æˆåŠŸ'
          document.getElementById('client-status').className = 'status success'

          // æ¯”è¼ƒï¼ˆstyleTagsã‚’é™¤ã„ã¦æ¯”è¼ƒï¼‰
          const ssrOutput = document.getElementById('ssr-output').innerHTML
          const clientOutput = document.getElementById('client-output').innerHTML
          // styleTagsã‚’é™¤ã„ã¦æ¯”è¼ƒ
          const ssrHtmlForCompare = ssrOutput.replace(styleTags, '')
          const clientHtmlForCompare = clientOutput.replace(styleTags, '')
          compareResults(ssrHtmlForCompare, clientHtmlForCompare)
        } catch (error) {
          console.error('Client rendering error:', error)
          document.getElementById('client-output').innerHTML =
            `<div class="error-message">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`
          document.getElementById('client-status').textContent = `ã‚¨ãƒ©ãƒ¼: ${error.message}`
          document.getElementById('client-status').className = 'status error'
        }
      }

      function compareResults(ssrHtml, clientHtml) {
        // ç©ºç™½ã¨æ”¹è¡Œã‚’æ­£è¦åŒ–ã—ã¦æ¯”è¼ƒ
        const normalize = (html) => html.replace(/\s+/g, ' ').trim()
        const ssrNormalized = normalize(ssrHtml)
        const clientNormalized = normalize(clientHtml)

        const isEqual = ssrNormalized === clientNormalized
        const resultDiv = document.getElementById('comparison-result')
        const detailsDiv = document.getElementById('comparison-details')

        resultDiv.style.display = 'block'

        if (isEqual) {
          resultDiv.style.background = '#d1fae5'
          detailsDiv.innerHTML = `
            <p style="color: #065f46; font-weight: bold;">HTMLæ§‹é€ ã¯ä¸€è‡´ã—ã¦ã„ã¾ã™</p>
            <p style="color: #047857; margin-top: 8px;">SSRã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°çµæœãŒä¸€è‡´ã—ã¾ã—ãŸã€‚</p>
          `
        } else {
          resultDiv.style.background = '#fee2e2'
          detailsDiv.innerHTML = `
            <p style="color: #991b1b; font-weight: bold;">HTMLæ§‹é€ ã«å·®ç•°ãŒã‚ã‚Šã¾ã™</p>
            <details style="margin-top: 12px;">
              <summary style="cursor: pointer; color: #7f1d1d;">è©³ç´°ã‚’è¡¨ç¤º</summary>
              <div style="margin-top: 8px; padding: 12px; background: white; border-radius: 4px;">
                <p><strong>SSRé•·:</strong> ${ssrNormalized.length} æ–‡å­—</p>
                <p><strong>Clienté•·:</strong> ${clientNormalized.length} æ–‡å­—</p>
                <p><strong>å·®ç•°:</strong> ${Math.abs(ssrNormalized.length - clientNormalized.length)} æ–‡å­—</p>
                <p style="margin-top: 12px; font-size: 12px; color: #6b7280;">
                  æ³¨: å±æ€§ã®é †åºã‚„ç©ºç™½ã®é•ã„ã«ã‚ˆã‚Šã€æ§‹é€ çš„ã«åŒã˜ã§ã‚‚å·®ç•°ãŒæ¤œå‡ºã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
                </p>
              </div>
            </details>
          `
        }
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init)
      } else {
        init()
      }
    </script>
  </body>
</html>
